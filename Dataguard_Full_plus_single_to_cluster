


-- ----------------------------------------------------------------------------------------
-->AMBIENTE PRIMARIO

Servidores Primarios:      krtn1db01.pitagoras.apollo.br
                              krtn1db02.pitagoras.apollo.br
                              krtn1db03.pitagoras.apollo.br
                              krtn1db04.pitagoras.apollo.br
                              n
TNS_Primarios:                bdprod / bdprod_link


-->AMBIENTE STANDBY
db_name:                     bdprod
db_unique_name:               bdproddr
Servidor standby:           krtn03db01
TNS_Standby:                bdprod_x8
-- ----------------------------------------------------------------------------------------

--> PRIMARY [X4] - Criar um serviÃ§o para conectar sempre na mesma Instancia no ambiente PRIMARIO

IMPORTANTE: adicionar o serviÃ§o bdprod_link no parametro service_names no banco de dados (em todas as instÃ¢ncias).

alter system set service_names='bdproddr, bdprodexa, bdprod_link' scope=both sid='*';

(#oracle) srvctl add service -d bdproddr -s bdprod_link -r bdproddr1
(#oracle) srvctl start service -d bdproddr -s bdprod_link


--> CONFIGURACOES DE TNS

#STANDBY - Subir um Listener LOCAL no "Servidor Standby" #-- Verificar se temos portas liberadas.
#Utilizando o LISTENER da InstalaÃ§Ã£o do GRID.                #-- Verificar se temos portas liberadas.

PRIMARY [X4] - Adicionar entradas no tnsnames.ora

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
BDPROD_x8 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.142.241)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodst)
  (UR=A)
  )
)

bdprod_link =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprod_link)
  )
)

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]


STANDBY [X8 - 12.1] - Adicionar entradas no tnsnames.ora

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
BDPROD_x8 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.142.241)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodst)
  (UR=A)
  )
)

BDPROD_x4 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodexa)
  )
)
bdprod_link =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprod_link)
  )
)
#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
--> PRIMARY [X4] - Configuracoes do Oracle Dataguard

ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';

alter system set LOG_ARCHIVE_CONFIG='DG_CONFIG=(bdproddr,bdprods,bdprodst)' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='SERVICE=BDPROD_x8 VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=BDPRODST' scope=both sid='*';
alter system set FAL_SERVER='BDPRODS','BDPRODST' scope=both sid='*';

STANDBY [X8 - 12.1] - Preparar o Banco Standby (auxiliary)
UvPaMgAacQ#B
     A) Copiar o arquivo PasswordFile do Banco PROMARIO [X4] para o Banco Standby (renomear o arquivo conforme nome do banco Standby)
scp orapwbdprodst1 oracle@krtn03db01:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst
scp orapwbdprodst1 oracle@krtn03db02:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst2
scp orapwbdprodst1 oracle@krtn03db03:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst3
scp orapwbdprodst1 oracle@krtn03db04:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst4
       
        - Se for necessario recirar o passwordfile:
               -1- Verifique os detalhes do arquivo atual (banco PRIMARIO [X3]):
                    select 'grant sysdba to '||USERNAME||';' from v$pwfile_users;
              
               -2- Altere a senha do usuari SYS no banco PRIMARIO [X3]
              
               -3- Recrie o arquivo passwordfile no X3 (NecessÃ¡rio em todos os DBNODEs):
                    orapwd file='/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwDWMSAF' entries=40
    
     B) Criar o diretÃ³rio "admin" para o banco Standby no Exadata X8.
          mkdir -p /u01/app/oracle/admin/BDPRODST/adump
    
     C) Criar um init (ORACLE_HOME/dbs/initBDPRODST.ora) para o banco Standby somente com os parÃ¢metros:
    
*.audit_file_dest='/u01/app/oracle/admin/BDPRODST/adump'
*.cluster_database=false
*.compatible='12.1.0.2.0'
*.control_files='+DATAC1/BDPRODST/CONTROLFILE/control01','+RECOC1/BDPRODST/CONTROLFILE/control02'
*.db_create_file_dest='+DATAC1'
*.db_create_online_log_dest_1='+RECOC1'
*.db_create_online_log_dest_2='+DATAC1'
*.db_files=1024
*.db_keep_cache_size=536870912
*.diagnostic_dest='/u01/app/oracle'
*.resource_limit=FALSE
*.db_name='BDPROD'
*.db_unique_name='BDPRODST'
*.log_archive_max_processes=10
*.fal_client='BDPRODST'
*.fal_server='BDPRODDR'
*.log_archive_config='dg_config=(bdproddr,bdprods,bdprodst)'
*.log_archive_dest_1='location=+RECOC1 valid_for=(ALL_LOGFILES,ALL_ROLES)'
*.log_archive_dest_5='service="BDPROD_x4" valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE)'
*.log_archive_dest_state_5='DEFER'
*.log_file_name_convert='+RECOC1/BDPRODDR/ONLINELOG','+RECOC1/BDPRODST/ONLINELOG','+DATAC1/BDPRODDR/ONLINELOG','+DATAC1/BDPRODST/ONLINELOG'
*.open_cursors=2000
*.service_names='bdproddr,bdprodexa'
*._disk_sector_size_override='TRUE'
*.processes=5000
*.session_cached_cursors=100
*.sessions=7000
*.sga_target=6G
*.sga_max_size=6G
*.shared_pool_size=2G
*.standby_file_management='AUTO'

     D) Startup NOMOUNT do banco STANDBY no X8 (auxiliary).


    
STANDBY [X8 - 12.1] - Iniciando o DUPLICATE ONLINE do X3 para o X8

     Em um dos servidores do X8 (Estou trabalhando no NODE1)
          A) export ORACLE_SID=BDPRODST
          B) rman target sys/Exasyskrot01@bdprod_link auxiliary sys/Exasyskrot01@BDPROD_x8         
         
          C) Duplicar o Banco PrimÃ¡rio como Standby (On-Line):


run {
allocate channel bdprodP1 type disk;
allocate channel bdprodP2 type disk;
allocate channel bdprodP3 type disk;
allocate channel bdprodP4 type disk;
allocate channel bdprodP5 type disk;
allocate channel bdprodP6 type disk;
allocate channel bdprodP7 type disk;
allocate channel bdprodP8 type disk;
allocate channel bdprodP10 type disk;
allocate channel bdprodP11 type disk;
allocate channel bdprodP12 type disk;
allocate channel bdprodP13 type disk;
allocate channel bdprodP14 type disk;
allocate channel bdprodP15 type disk;
allocate channel bdprodP16 type disk;
allocate channel bdprodP17 type disk;
allocate channel bdprodP18 type disk;
allocate channel bdprodP19 type disk;
allocate channel bdprodP20 type disk;
allocate channel bdprodP21 type disk;
allocate channel bdprodP22 type disk;
allocate auxiliary channel      bdprodSTB1     type disk;
allocate auxiliary channel      bdprodSTB2     type disk;
allocate auxiliary channel      bdprodSTB3     type disk;
allocate auxiliary channel      bdprodSTB4     type disk;
allocate auxiliary channel      bdprodSTB5     type disk;
allocate auxiliary channel      bdprodSTB6     type disk;
allocate auxiliary channel      bdprodSTB7      type disk;
allocate auxiliary channel      bdprodSTB8   type disk;
allocate auxiliary channel      bdprodSTB10  type disk;
allocate auxiliary channel      bdprodSTB11  type disk;
allocate auxiliary channel      bdprodSTB12  type disk;
allocate auxiliary channel      bdprodSTB13  type disk;
allocate auxiliary channel      bdprodSTB14  type disk;
allocate auxiliary channel      bdprodSTB15  type disk;
allocate auxiliary channel      bdprodSTB16  type disk;
allocate auxiliary channel      bdprodSTB17  type disk;
allocate auxiliary channel      bdprodSTB18  type disk;
allocate auxiliary channel      bdprodSTB19  type disk;
allocate auxiliary channel      bdprodSTB20  type disk;
allocate auxiliary channel      bdprodSTB21  type disk;
allocate auxiliary channel      bdprodSTB22  type disk;
duplicate target database for standby from active database;
}


nohup rman target sys/@bdprod_link auxiliary sys/@BDPROD_x8 @/home/oracle/duplicate_x4/rman_bdproddr.cmd > nohup_$ORACLE_SID.out 2>&1&

-- -------------------------------------------------------------------------------------
-- MONITORAR O ANDAMENTO DO DUPLICATE  [No Banco PrimÃ¡rio]
-- -------------------------------------------------------------------------------------

# Andamento do Duplicate...
alter session set nls_date_format='dd/mm/yy hh24:mi:ss';
set lines 300
select SID, START_TIME,TOTALWORK, sofar, round(((sofar/totalwork) * 100),2) "% Completed", sysdate + TIME_REMAINING/3600/24 end_at from v$session_longops where totalwork > sofar AND opname NOT LIKE '%aggregate%' AND opname like 'RMAN%'
/

# Eventos de WAIT relacionados ao Duplicate...
REM RMAN waits
set lines 120
column sid format 9999
column spid format 99999
column client_info format a25
column event format a30
column secs format 9999
SELECT SID,SPID, CLIENT_INFO, event, seconds_in_wait secs, p1, p2, p3 FROM V$PROCESS p, V$SESSION s  WHERE p.ADDR = s.PADDR and CLIENT_INFO like 'rman channel=%';



-- ----------------------------------------------------------------------------
     INICIANDO O SERVIÃ‡O â€œMRPâ€ NO SERVIDOR DO STANDBY DATABASE
-- ----------------------------------------------------------------------------
--> No Banco PRIMARY [X4]:
alter system set archive_lag_target=900 scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=ENABLE scope=both sid='*';


--> No Banco STANDBY [X8 - 12.1]:
(No Real Time Apply)
(START).: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;
            ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT PARALLEL 6;
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
 
 
(Real Time Apply) 
To  use  Real Time  Apply , Standby  redo  logfiles  are  mandatory.
Once , the standby redo logfiles has been created on the standby use

(START).: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6; 
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL; 
 

(Real Time Query)   
--> O banco deve estar "MONTED" e o serviÃ§o MRP nÃ£o pode estar ativo.
(START).: ALTER DATABASE OPEN;
            ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT;
            ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6;
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;

-- ----------------------------------------------------------------------------
     ALTERANDO O STABDBY para READ ONLY
-- ----------------------------------------------------------------------------
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
ALTER DATABASE OPEN READ ONLY;


-- --------------------------------------------------------------------------------
     DISPONIBILIZANDO o BANCO DRP (Failover) -- Interrompendo a ReplicaÃ§Ã£o...
-- --------------------------------------------------------------------------------
--> No Banco PrimÃ¡rio:
ALTER SYSTEM SWITCH LOGFILE;
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';


--> No Banco Standby:
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE FINISH;
ALTER DATABASE ACTIVATE STANDBY DATABASE;

alter database open;

-- ----------------------------------------- EUQUALIZANDO PARAMETROS DO BANCO

--> Pegar os parametros do banco de producao no X4

set lines 200
set pages 100
select 'alter system set '||NAME||'='||VALUE||' scope=spfile sid=''*'';' from  v$parameter
where NAME in ('sga_max_size'
,'sga_target'
,'pga_aggregate_limit'
,'pga_aggregate_target'
,'shared_pool_reserved_size'
,'shared_pool_size'
,'db_cache_size'
,'cursor_sharing'
,'open_cursors'
,'session_cached_cursors'
,'session_max_open_files'
,'sessions'
,'db_writer_processes'
,'job_queue_processes'
,'processes'
,'db_files')
order by NAME;

--> Rodar o resultado no banco de destino no X8

create pfile='/home/oracle/pfile_BDPRODST.bkp' from spfile;


-- -------------------------- MONITORAR O BANCO STANDBY

#VERIFICA STATUS DOS SERVIÃ‡OS DO STANDBY (DATAGUARD).:
Set pages 50
SELECT PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM V$MANAGED_STANDBY;

--> CLUSTER
Set pages 50
SELECT
INST_ID,
PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM GV$MANAGED_STANDBY
where PROCESS like '%MRP%';


#VERIFICA OS ARCHIVES RECEBIDOS E SE FORAM APLICADOS.:
set pages 10
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG ORDER BY SEQUENCE#;


SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG where APPLIED='NO' ORDER BY SEQUENCE#;


--> na ultima 1 hora
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG
where APPLIED <> 'YES'
and NEXT_TIME > sysdate-1
ORDER BY SEQUENCE#;


Set Linesize 400
Col Values For A65
Col Recover_start For A21
Select To_char(START_TIME,'Dd.Mm.Yyyy Hh24:Mi:ss') "Recover_start",To_char(Item)||' = '||To_char(Sofar)||' '||To_char(Units)||' '|| To_char(TIMESTAMP,'Dd.Mm.Yyyy Hh24:Mi') "Values" From V$Recovery_progress Where Start_time=(Select Max(Start_time) From V$Recovery_progress);


SELECT count(*) FROM V$ARCHIVED_LOG where APPLIED='NO' ORDER BY SEQUENCE#;


#VERIFICA OS ERROS NO STANDBY.:
SET LINES 100
SET PAGES 500
SELECT MESSAGE FROM V$DATAGUARD_STATUS; 
 
  
-- ---------------VERIFICAR / MONITORAR os SERVIÃ‡OS no BANCO PRIMARIO
set lines 300
set pages 100
col DEST_NAME for a30
col error for a90
select INST_ID, DEST_NAME,status,error from  gv$archive_dest
where DEST_NAME = 'LOG_ARCHIVE_DEST_5'; 
 
SET LINES 100
SET PAGES 500
SELECT MESSAGE FROM V$DATAGUARD_STATUS;  


-- --------------------------------------------------------------------------------
     VERIFICANDO O SINCRONISMO
-- --------------------------------------------------------------------------------

1. No Servidor PRIMIARIO:

set lines 100
set pages 10
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
select THREAD#, Sequence#,first_time,next_time
from v$archived_log
where (COMPLETION_TIME) >= (select sysdate-1/6 from dual);

ALTER SYSTEM SWITCH LOGFILE;
2. No Servidor STANDBY - Verifique se o Archive foi Recebido:

set lines 100
set pages 10
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
select THREAD#,Sequence#,first_time,next_time,applied
from v$archived_log where dest_id=5 and
(COMPLETION_TIME) >= (select sysdate-1/6 from dual);



-- ----------------------------------------------------------------------------------------
-- Para Limpar as configuraÃ§Ãµes do Standby no Banco de Dados Primario
-- ----------------------------------------------------------------------------------------
# No RMAN
rman target sys/orakroiuni@DWMSAF catalog rman/mu2t4ng
CONFIGURE ARCHIVELOG DELETION POLICY TO NONE;

# No Banco (SQL*Plus)
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_6='' scope=both sid='*';
alter system set log_archive_config=NODG_CONFIG  scope=both sid='*';
alter system set FAL_SERVER='' scope=both sid='*';
alter system set FAL_CLIENT='' scope=both sid='*';
ALTER SYSTEM set archive_lag_target=0 scope=both sid='*';



--> Verificar Status das ConfiguraÃ§Ãµes
set lines 300
set pages 100
col DEST_NAME for a30
col DESTINATION for a30
select DEST_ID, DEST_NAME,DESTINATION from v$archive_dest;
select DEST_NAME,status,error from  v$archive_dest; 


---

---
V1
---

---

-- ----------------------------------------------------------------------------------------
-->AMBIENTE PRIMARIO

Servidores Primarios:     krtn1db01.pitagoras.apollo.br
                        krtn1db02.pitagoras.apollo.br
                        krtn1db03.pitagoras.apollo.br
                        krtn1db04.pitagoras.apollo.br
                        
TNS_Primarios:             bdprod / bdprod_link


-->AMBIENTE STANDBY
db_name:                 bdprod
db_unique_name:            bdproddr
Servidor standby:         krtn03db01
TNS_Standby:             bdprod_x8
-- ----------------------------------------------------------------------------------------

--> PRIMARY [X4] - Criar um serviço para conectar sempre na mesma Instancia no ambiente PRIMARIO

IMPORTANTE: adicionar o serviço bdprod_link no parametro service_names no banco de dados (em todas as instâncias).

alter system set service_names='bdproddr, bdprodexa, bdprod_link' scope=both sid='*';

(#oracle) srvctl add service -d bdproddr -s bdprod_link -r bdproddr1
(#oracle) srvctl start service -d bdproddr -s bdprod_link


--> CONFIGURACOES DE TNS

#STANDBY - Subir um Listener LOCAL no "Servidor Standby" #-- Verificar se temos portas liberadas.
#Utilizando o LISTENER da Instalação do GRID.              #-- Verificar se temos portas liberadas.

PRIMARY [X4] - Adicionar entradas no tnsnames.ora

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
BDPROD_x8 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.142.241)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodst)
  (UR=A)
  )
)

bdprod_link =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprod_link)
  )
)

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]


STANDBY [X8 - 12.1] - Adicionar entradas no tnsnames.ora

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
BDPROD_x8 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.142.241)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodst)
  (UR=A)
  )
)

BDPROD_x4 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodexa)
  )
)
bdprod_link =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprod_link)
  )
)
#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
--> PRIMARY [X4] - Configuracoes do Oracle Dataguard

ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';

alter system set LOG_ARCHIVE_CONFIG='DG_CONFIG=(bdproddr,bdprods,bdprodst)' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='SERVICE=BDPROD_x8 VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=BDPRODST' scope=both sid='*';
alter system set FAL_SERVER='BDPRODS','BDPRODST' scope=both sid='*';

STANDBY [X8 - 12.1] - Preparar o Banco Standby (auxiliary)
UvPaMgAacQ#B
    A) Copiar o arquivo PasswordFile do Banco PROMARIO [X4] para o Banco Standby (renomear o arquivo conforme nome do banco Standby)
scp orapwbdprodst1 oracle@krtn03db01:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst
scp orapwbdprodst1 oracle@krtn03db02:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst2
scp orapwbdprodst1 oracle@krtn03db03:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst3
scp orapwbdprodst1 oracle@krtn03db04:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst4
       
       - Se for necessario recirar o passwordfile:
            -1- Verifique os detalhes do arquivo atual (banco PRIMARIO [X3]):
                select 'grant sysdba to '||USERNAME||';' from v$pwfile_users;
            
            -2- Altere a senha do usuari SYS no banco PRIMARIO [X3]
            
            -3- Recrie o arquivo passwordfile no X3 (Necessário em todos os DBNODEs):
                orapwd file='/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwDWMSAF' entries=40
    
    B) Criar o diretório "admin" para o banco Standby no Exadata X8.
        mkdir -p /u01/app/oracle/admin/BDPRODST/adump
    
    C) Criar um init (ORACLE_HOME/dbs/initBDPRODST.ora) para o banco Standby somente com os parâmetros:
    
*.audit_file_dest='/u01/app/oracle/admin/BDPRODST/adump'
*.cluster_database=false
*.compatible='12.1.0.2.0'
*.control_files='+DATAC1/BDPRODST/CONTROLFILE/control01','+RECOC1/BDPRODST/CONTROLFILE/control02'
*.db_create_file_dest='+DATAC1'
*.db_create_online_log_dest_1='+RECOC1'
*.db_create_online_log_dest_2='+DATAC1'
*.db_files=1024
*.db_keep_cache_size=536870912
*.diagnostic_dest='/u01/app/oracle'
*.resource_limit=FALSE
*.db_name='BDPROD'
*.db_unique_name='BDPRODST'
*.log_archive_max_processes=10
*.fal_client='BDPRODST'
*.fal_server='BDPRODDR'
*.log_archive_config='dg_config=(bdproddr,bdprods,bdprodst)'
*.log_archive_dest_1='location=+RECOC1 valid_for=(ALL_LOGFILES,ALL_ROLES)'
*.log_archive_dest_5='service="BDPROD_x4" valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE)'
*.log_archive_dest_state_5='DEFER'
*.log_file_name_convert='+RECOC1/BDPRODDR/ONLINELOG','+RECOC1/BDPRODST/ONLINELOG','+DATAC1/BDPRODDR/ONLINELOG','+DATAC1/BDPRODST/ONLINELOG'
*.open_cursors=2000
*.service_names='bdproddr,bdprodexa'
*._disk_sector_size_override='TRUE'
*.processes=5000
*.session_cached_cursors=100
*.sessions=7000
*.sga_target=6G
*.sga_max_size=6G
*.shared_pool_size=2G
*.standby_file_management='AUTO'

    D) Startup NOMOUNT do banco STANDBY no X8 (auxiliary).


    
STANDBY [X8 - 12.1] - Iniciando o DUPLICATE ONLINE do X3 para o X8

    Em um dos servidores do X8 (Estou trabalhando no NODE1)
        A) export ORACLE_SID=BDPRODST
        B) rman target sys/Exasyskrot01@bdprod_link auxiliary sys/Exasyskrot01@BDPROD_x8        
        
        C) Duplicar o Banco Primário como Standby (On-Line):


run {
allocate channel bdprodP1 type disk;
allocate channel bdprodP2 type disk;
allocate channel bdprodP3 type disk;
allocate channel bdprodP4 type disk;
allocate channel bdprodP5 type disk;
allocate channel bdprodP6 type disk;
allocate channel bdprodP7 type disk;
allocate channel bdprodP8 type disk;
allocate channel bdprodP10 type disk;
allocate channel bdprodP11 type disk;
allocate channel bdprodP12 type disk;
allocate channel bdprodP13 type disk;
allocate channel bdprodP14 type disk;
allocate channel bdprodP15 type disk;
allocate channel bdprodP16 type disk;
allocate channel bdprodP17 type disk;
allocate channel bdprodP18 type disk;
allocate channel bdprodP19 type disk;
allocate channel bdprodP20 type disk;
allocate channel bdprodP21 type disk;
allocate channel bdprodP22 type disk;
allocate auxiliary channel     bdprodSTB1     type disk;
allocate auxiliary channel     bdprodSTB2     type disk;
allocate auxiliary channel     bdprodSTB3     type disk;
allocate auxiliary channel     bdprodSTB4     type disk;
allocate auxiliary channel     bdprodSTB5     type disk;
allocate auxiliary channel     bdprodSTB6     type disk;
allocate auxiliary channel     bdprodSTB7      type disk;
allocate auxiliary channel     bdprodSTB8   type disk;
allocate auxiliary channel     bdprodSTB10  type disk;
allocate auxiliary channel     bdprodSTB11  type disk;
allocate auxiliary channel     bdprodSTB12  type disk;
allocate auxiliary channel     bdprodSTB13  type disk;
allocate auxiliary channel     bdprodSTB14  type disk;
allocate auxiliary channel     bdprodSTB15  type disk;
allocate auxiliary channel     bdprodSTB16  type disk;
allocate auxiliary channel     bdprodSTB17  type disk;
allocate auxiliary channel     bdprodSTB18  type disk;
allocate auxiliary channel     bdprodSTB19  type disk;
allocate auxiliary channel     bdprodSTB20  type disk;
allocate auxiliary channel     bdprodSTB21  type disk;
allocate auxiliary channel     bdprodSTB22  type disk;
duplicate target database for standby from active database;
}


nohup rman target sys/@bdprod_link auxiliary sys/@BDPROD_x8 @/home/oracle/duplicate_x4/rman_bdproddr.cmd > nohup_$ORACLE_SID.out 2>&1&

-- -------------------------------------------------------------------------------------
-- MONITORAR O ANDAMENTO DO DUPLICATE  [No Banco Primário]
-- -------------------------------------------------------------------------------------

# Andamento do Duplicate...
alter session set nls_date_format='dd/mm/yy hh24:mi:ss';
set lines 300
select SID, START_TIME,TOTALWORK, sofar, round(((sofar/totalwork) * 100),2) "% Completed", sysdate + TIME_REMAINING/3600/24 end_at from v$session_longops where totalwork > sofar AND opname NOT LIKE '%aggregate%' AND opname like 'RMAN%'
/

# Eventos de WAIT relacionados ao Duplicate...
REM RMAN waits
set lines 120
column sid format 9999
column spid format 99999
column client_info format a25
column event format a30
column secs format 9999
SELECT SID,SPID, CLIENT_INFO, event, seconds_in_wait secs, p1, p2, p3 FROM V$PROCESS p, V$SESSION s  WHERE p.ADDR = s.PADDR and CLIENT_INFO like 'rman channel=%';



-- ----------------------------------------------------------------------------
    INICIANDO O SERVIÇO “MRP” NO SERVIDOR DO STANDBY DATABASE
-- ----------------------------------------------------------------------------
--> No Banco PRIMARY [X4]:
alter system set archive_lag_target=900 scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=ENABLE scope=both sid='*';


--> No Banco STANDBY [X8 - 12.1]:
(No Real Time Apply)
(START).: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;
          ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT PARALLEL 6;
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
  
  
(Real Time Apply)  
To  use  Real Time  Apply , Standby  redo  logfiles  are  mandatory.
Once , the standby redo logfiles has been created on the standby use

(START).: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6;  
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;  
  

(Real Time Query)    
--> O banco deve estar "MONTED" e o serviço MRP não pode estar ativo.
(START).: ALTER DATABASE OPEN;
          ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT;
          ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6;
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;

-- ----------------------------------------------------------------------------
    ALTERANDO O STABDBY para READ ONLY
-- ----------------------------------------------------------------------------
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
ALTER DATABASE OPEN READ ONLY;


-- --------------------------------------------------------------------------------
    DISPONIBILIZANDO o BANCO DRP (Failover) -- Interrompendo a Replicação...
-- --------------------------------------------------------------------------------
--> No Banco Primário:
ALTER SYSTEM SWITCH LOGFILE;
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';

--> No Banco Standby:
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE FINISH;
ALTER DATABASE ACTIVATE STANDBY DATABASE;

alter database open;

-- ----------------------------------------- EUQUALIZANDO PARAMETROS DO BANCO

--> Pegar os parametros do banco de producao no X4

set lines 200
set pages 100
select 'alter system set '||NAME||'='||VALUE||' scope=spfile sid=''*'';' from  v$parameter
where NAME in ('sga_max_size'
,'sga_target'
,'pga_aggregate_limit'
,'pga_aggregate_target'
,'shared_pool_reserved_size'
,'shared_pool_size'
,'db_cache_size'
,'cursor_sharing'
,'open_cursors'
,'session_cached_cursors'
,'session_max_open_files'
,'sessions'
,'db_writer_processes'
,'job_queue_processes'
,'processes'
,'db_files')
order by NAME;

--> Rodar o resultado no banco de destino no X8

create pfile='/home/oracle/pfile_BDPRODST.bkp' from spfile;


-- -------------------------- MONITORAR O BANCO STANDBY

#VERIFICA STATUS DOS SERVIÇOS DO STANDBY (DATAGUARD).:
Set pages 50
SELECT PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM V$MANAGED_STANDBY;

--> CLUSTER
Set pages 50
SELECT
INST_ID,
PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM GV$MANAGED_STANDBY
where PROCESS like '%MRP%';


#VERIFICA OS ARCHIVES RECEBIDOS E SE FORAM APLICADOS.:
set pages 10
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG ORDER BY SEQUENCE#;


SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG where APPLIED='NO' ORDER BY SEQUENCE#;


--> na ultima 1 hora
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG
where APPLIED <> 'YES'
and NEXT_TIME > sysdate-1
ORDER BY SEQUENCE#;


Set Linesize 400
Col Values For A65
Col Recover_start For A21
Select To_char(START_TIME,'Dd.Mm.Yyyy Hh24:Mi:ss') "Recover_start",To_char(Item)||' = '||To_char(Sofar)||' '||To_char(Units)||' '|| To_char(TIMESTAMP,'Dd.Mm.Yyyy Hh24:Mi') "Values" From V$Recovery_progress Where Start_time=(Select Max(Start_time) From V$Recovery_progress);


SELECT count(*) FROM V$ARCHIVED_LOG where APPLIED='NO' ORDER BY SEQUENCE#;


#VERIFICA OS ERROS NO STANDBY.:
SET LINES 100
SET PAGES 500
SELECT MESSAGE FROM V$DATAGUARD_STATUS;  
  
   
-- ---------------VERIFICAR / MONITORAR os SERVIÇOS no BANCO PRIMARIO
set lines 300
set pages 100
col DEST_NAME for a30
col error for a90
select INST_ID, DEST_NAME,status,error from  gv$archive_dest
where DEST_NAME = 'LOG_ARCHIVE_DEST_5';  
  
SET LINES 100
SET PAGES 500
SELECT MESSAGE FROM V$DATAGUARD_STATUS;   


-- --------------------------------------------------------------------------------
    VERIFICANDO O SINCRONISMO
-- --------------------------------------------------------------------------------

1. No Servidor PRIMIARIO:

set lines 100
set pages 10
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
select THREAD#, Sequence#,first_time,next_time
from v$archived_log
where (COMPLETION_TIME) >= (select sysdate-1/6 from dual);

ALTER SYSTEM SWITCH LOGFILE;
2. No Servidor STANDBY - Verifique se o Archive foi Recebido:

set lines 100
set pages 10
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
select THREAD#,Sequence#,first_time,next_time,applied
from v$archived_log where dest_id=5 and
(COMPLETION_TIME) >= (select sysdate-1/6 from dual);



-- ----------------------------------------------------------------------------------------
-- Para Limpar as configurações do Standby no Banco de Dados Primario
-- ----------------------------------------------------------------------------------------
# No RMAN
rman target sys/orakroiuni@DWMSAF catalog rman/mu2t4ng
CONFIGURE ARCHIVELOG DELETION POLICY TO NONE;

# No Banco (SQL*Plus)
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_6='' scope=both sid='*';
alter system set log_archive_config=NODG_CONFIG  scope=both sid='*';
alter system set FAL_SERVER='' scope=both sid='*';
alter system set FAL_CLIENT='' scope=both sid='*';
ALTER SYSTEM set archive_lag_target=0 scope=both sid='*';



--> Verificar Status das Configurações
set lines 300
set pages 100
col DEST_NAME for a30
col DESTINATION for a30
select DEST_ID, DEST_NAME,DESTINATION from v$archive_dest;
select DEST_NAME,status,error from  v$archive_dest;  





---

---
V2
---

---


-- ----------------------------------------------------------------------------------------
-->AMBIENTE PRIMARIO
db_name:                 DWMSAF
db_unique_name:            DWMSAF
Servidores Primarios:     krtn1db01.pitagoras.apollo.br
                        krtn1db02.pitagoras.apollo.br
                        krtn1db03.pitagoras.apollo.br
                        krtn1db04.pitagoras.apollo.br
                        
TNS_Primarios:             bdprod / bdprod_link


-->AMBIENTE STANDBY
db_name:                 bdprod
db_unique_name:            bdproddr
Servidor standby:         krtn03db01
TNS_Standby:             bdprod_x8
-- ----------------------------------------------------------------------------------------

--> PRIMARY [X4] - Criar um serviço para conectar sempre na mesma Instancia no ambiente PRIMARIO

IMPORTANTE: adicionar o serviço bdprod_link no parametro service_names no banco de dados (em todas as instâncias).

alter system set service_names='bdproddr, bdprodexa, bdprod_link' scope=both sid='*';

(#oracle) srvctl add service -d bdproddr -s bdprod_link -r bdproddr1
(#oracle) srvctl start service -d bdproddr -s bdprod_link


--> CONFIGURACOES DE TNS

#STANDBY - Subir um Listener LOCAL no "Servidor Standby" #-- Verificar se temos portas liberadas.
#Utilizando o LISTENER da Instalação do GRID.              #-- Verificar se temos portas liberadas.

PRIMARY [X4] - Adicionar entradas no tnsnames.ora

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
BDPROD_x8 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.142.241)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodst)
  (UR=A)
  )
)

bdprod_link =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprod_link)
  )
)

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]


STANDBY [X8 - 12.1] - Adicionar entradas no tnsnames.ora

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
BDPROD_x8 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.142.241)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodst)
  (UR=A)
  )
)

BDPROD_x4 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodexa)
  )
)
bdprod_link =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprod_link)
  )
)
#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
--> PRIMARY [X4] - Configuracoes do Oracle Dataguard

ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';

alter system set LOG_ARCHIVE_CONFIG='DG_CONFIG=(bdproddr,bdprods,bdprodst)' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='SERVICE=BDPROD_x8 VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=BDPRODST' scope=both sid='*';
alter system set FAL_SERVER='BDPRODS','BDPRODST' scope=both sid='*';

STANDBY [X8 - 12.1] - Preparar o Banco Standby (auxiliary)
UvPaMgAacQ#B
    A) Copiar o arquivo PasswordFile do Banco PROMARIO [X4] para o Banco Standby (renomear o arquivo conforme nome do banco Standby)
scp orapwbdprodst1 oracle@krtn03db01:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst
scp orapwbdprodst1 oracle@krtn03db02:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst2
scp orapwbdprodst1 oracle@krtn03db03:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst3
scp orapwbdprodst1 oracle@krtn03db04:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst4
       
       - Se for necessario recirar o passwordfile:
            -1- Verifique os detalhes do arquivo atual (banco PRIMARIO [X3]):
                select 'grant sysdba to '||USERNAME||';' from v$pwfile_users;
            
            -2- Altere a senha do usuari SYS no banco PRIMARIO [X3]
            
            -3- Recrie o arquivo passwordfile no X3 (Necessário em todos os DBNODEs):
                orapwd file='/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwDWMSAF' entries=40
    
    B) Criar o diretório "admin" para o banco Standby no Exadata X8.
        mkdir -p /u01/app/oracle/admin/BDPRODST/adump
    
    C) Criar um init (ORACLE_HOME/dbs/initBDPRODST.ora) para o banco Standby somente com os parâmetros:
    
*.audit_file_dest='/u01/app/oracle/admin/BDPRODST/adump'
*.cluster_database=false
*.compatible='12.1.0.2.0'
*.control_files='+DATAC1/BDPRODST/CONTROLFILE/control01','+RECOC1/BDPRODST/CONTROLFILE/control02'
*.db_create_file_dest='+DATAC1'
*.db_create_online_log_dest_1='+RECOC1'
*.db_create_online_log_dest_2='+DATAC1'
*.db_files=1024
*.db_keep_cache_size=536870912
*.diagnostic_dest='/u01/app/oracle'
*.resource_limit=FALSE
*.db_name='BDPROD'
*.db_unique_name='BDPRODST'
*.log_archive_max_processes=10
*.fal_client='BDPRODST'
*.fal_server='BDPRODDR'
*.log_archive_config='dg_config=(bdproddr,bdprods,bdprodst)'
*.log_archive_dest_1='location=+RECOC1 valid_for=(ALL_LOGFILES,ALL_ROLES)'
*.log_archive_dest_5='service="BDPROD_x4" valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE)'
*.log_archive_dest_state_5='DEFER'
*.log_file_name_convert='+RECOC1/BDPRODDR/ONLINELOG','+RECOC1/BDPRODST/ONLINELOG','+DATAC1/BDPRODDR/ONLINELOG','+DATAC1/BDPRODST/ONLINELOG'
*.open_cursors=2000
*.service_names='bdproddr,bdprodexa'
*._disk_sector_size_override='TRUE'
*.processes=5000
*.session_cached_cursors=100
*.sessions=7000
*.sga_target=6G
*.sga_max_size=6G
*.shared_pool_size=2G
*.standby_file_management='AUTO'

    D) Startup NOMOUNT do banco STANDBY no X8 (auxiliary).


    
STANDBY [X8 - 12.1] - Iniciando o DUPLICATE ONLINE do X3 para o X8

    Em um dos servidores do X8 (Estou trabalhando no NODE1)
        A) export ORACLE_SID=BDPRODST
        B) rman target sys/Exasyskrot01@bdprod_link auxiliary sys/Exasyskrot01@BDPROD_x8        
        
        C) Duplicar o Banco Primário como Standby (On-Line):


run {
allocate channel bdprodP1 type disk;
allocate channel bdprodP2 type disk;
allocate channel bdprodP3 type disk;
allocate channel bdprodP4 type disk;
allocate channel bdprodP5 type disk;
allocate channel bdprodP6 type disk;
allocate channel bdprodP7 type disk;
allocate channel bdprodP8 type disk;
allocate channel bdprodP10 type disk;
allocate channel bdprodP11 type disk;
allocate channel bdprodP12 type disk;
allocate channel bdprodP13 type disk;
allocate channel bdprodP14 type disk;
allocate channel bdprodP15 type disk;
allocate channel bdprodP16 type disk;
allocate channel bdprodP17 type disk;
allocate channel bdprodP18 type disk;
allocate channel bdprodP19 type disk;
allocate channel bdprodP20 type disk;
allocate channel bdprodP21 type disk;
allocate channel bdprodP22 type disk;
allocate auxiliary channel     bdprodSTB1     type disk;
allocate auxiliary channel     bdprodSTB2     type disk;
allocate auxiliary channel     bdprodSTB3     type disk;
allocate auxiliary channel     bdprodSTB4     type disk;
allocate auxiliary channel     bdprodSTB5     type disk;
allocate auxiliary channel     bdprodSTB6     type disk;
allocate auxiliary channel     bdprodSTB7      type disk;
allocate auxiliary channel     bdprodSTB8   type disk;
allocate auxiliary channel     bdprodSTB10  type disk;
allocate auxiliary channel     bdprodSTB11  type disk;
allocate auxiliary channel     bdprodSTB12  type disk;
allocate auxiliary channel     bdprodSTB13  type disk;
allocate auxiliary channel     bdprodSTB14  type disk;
allocate auxiliary channel     bdprodSTB15  type disk;
allocate auxiliary channel     bdprodSTB16  type disk;
allocate auxiliary channel     bdprodSTB17  type disk;
allocate auxiliary channel     bdprodSTB18  type disk;
allocate auxiliary channel     bdprodSTB19  type disk;
allocate auxiliary channel     bdprodSTB20  type disk;
allocate auxiliary channel     bdprodSTB21  type disk;
allocate auxiliary channel     bdprodSTB22  type disk;
duplicate target database for standby from active database;
}


nohup rman target sys/@bdprod_link auxiliary sys/@BDPROD_x8 @/home/oracle/duplicate_x4/rman_bdproddr.cmd > nohup_$ORACLE_SID.out 2>&1&

-- -------------------------------------------------------------------------------------
-- MONITORAR O ANDAMENTO DO DUPLICATE  [No Banco Primário]
-- -------------------------------------------------------------------------------------

# Andamento do Duplicate...
alter session set nls_date_format='dd/mm/yy hh24:mi:ss';
set lines 300
select SID, START_TIME,TOTALWORK, sofar, round(((sofar/totalwork) * 100),2) "% Completed", sysdate + TIME_REMAINING/3600/24 end_at from v$session_longops where totalwork > sofar AND opname NOT LIKE '%aggregate%' AND opname like 'RMAN%'
/

# Eventos de WAIT relacionados ao Duplicate...
REM RMAN waits
set lines 120
column sid format 9999
column spid format 99999
column client_info format a25
column event format a30
column secs format 9999
SELECT SID,SPID, CLIENT_INFO, event, seconds_in_wait secs, p1, p2, p3 FROM V$PROCESS p, V$SESSION s  WHERE p.ADDR = s.PADDR and CLIENT_INFO like 'rman channel=%';



-- ----------------------------------------------------------------------------
    INICIANDO O SERVIÇO “MRP” NO SERVIDOR DO STANDBY DATABASE
-- ----------------------------------------------------------------------------
--> No Banco PRIMARY [X4]:
alter system set archive_lag_target=900 scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=ENABLE scope=both sid='*';


--> No Banco STANDBY [X8 - 12.1]:
(No Real Time Apply)
(START).: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;
          ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT PARALLEL 6;
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
  
  
(Real Time Apply)  
To  use  Real Time  Apply , Standby  redo  logfiles  are  mandatory.
Once , the standby redo logfiles has been created on the standby use

(START).: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6;  
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;  
  

(Real Time Query)    
--> O banco deve estar "MONTED" e o serviço MRP não pode estar ativo.
(START).: ALTER DATABASE OPEN;
          ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT;
          ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6;
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;

-- ----------------------------------------------------------------------------
    ALTERANDO O STABDBY para READ ONLY
-- ----------------------------------------------------------------------------
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
ALTER DATABASE OPEN READ ONLY;


-- --------------------------------------------------------------------------------
    DISPONIBILIZANDO o BANCO DRP (Failover) -- Interrompendo a Replicação...
-- --------------------------------------------------------------------------------
--> No Banco Primário:
ALTER SYSTEM SWITCH LOGFILE;
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';


--> No Banco Standby:
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE FINISH;
ALTER DATABASE ACTIVATE STANDBY DATABASE;

alter database open;

-- ----------------------------------------- EUQUALIZANDO PARAMETROS DO BANCO

--> Pegar os parametros do banco de producao no X4

set lines 200
set pages 100
select 'alter system set '||NAME||'='||VALUE||' scope=spfile sid=''*'';' from  v$parameter
where NAME in ('sga_max_size'
,'sga_target'
,'pga_aggregate_limit'
,'pga_aggregate_target'
,'shared_pool_reserved_size'
,'shared_pool_size'
,'db_cache_size'
,'cursor_sharing'
,'open_cursors'
,'session_cached_cursors'
,'session_max_open_files'
,'sessions'
,'db_writer_processes'
,'job_queue_processes'
,'processes'
,'db_files')
order by NAME;

--> Rodar o resultado no banco de destino no X8

create pfile='/home/oracle/pfile_BDPRODST.bkp' from spfile;


-- -------------------------- MONITORAR O BANCO STANDBY

#VERIFICA STATUS DOS SERVIÇOS DO STANDBY (DATAGUARD).:
Set pages 50
SELECT PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM V$MANAGED_STANDBY;

--> CLUSTER
Set pages 50
SELECT
INST_ID,
PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM GV$MANAGED_STANDBY
where PROCESS like '%MRP%';


#VERIFICA OS ARCHIVES RECEBIDOS E SE FORAM APLICADOS.:
set pages 10
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG ORDER BY SEQUENCE#;


SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG where APPLIED='NO' ORDER BY SEQUENCE#;


--> na ultima 1 hora
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG
where APPLIED <> 'YES'
and NEXT_TIME > sysdate-1
ORDER BY SEQUENCE#;


Set Linesize 400
Col Values For A65
Col Recover_start For A21
Select To_char(START_TIME,'Dd.Mm.Yyyy Hh24:Mi:ss') "Recover_start",To_char(Item)||' = '||To_char(Sofar)||' '||To_char(Units)||' '|| To_char(TIMESTAMP,'Dd.Mm.Yyyy Hh24:Mi') "Values" From V$Recovery_progress Where Start_time=(Select Max(Start_time) From V$Recovery_progress);


SELECT count(*) FROM V$ARCHIVED_LOG where APPLIED='NO' ORDER BY SEQUENCE#;


#VERIFICA OS ERROS NO STANDBY.:
SET LINES 100
SET PAGES 500
SELECT MESSAGE FROM V$DATAGUARD_STATUS;  
  
   
-- ---------------VERIFICAR / MONITORAR os SERVIÇOS no BANCO PRIMARIO
set lines 300
set pages 100
col DEST_NAME for a30
col error for a90
select INST_ID, DEST_NAME,status,error from  gv$archive_dest
where DEST_NAME = 'LOG_ARCHIVE_DEST_5';  
  
SET LINES 100
SET PAGES 500
SELECT MESSAGE FROM V$DATAGUARD_STATUS;   


-- --------------------------------------------------------------------------------
    VERIFICANDO O SINCRONISMO
-- --------------------------------------------------------------------------------

1. No Servidor PRIMIARIO:

set lines 100
set pages 10
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
select THREAD#, Sequence#,first_time,next_time
from v$archived_log
where (COMPLETION_TIME) >= (select sysdate-1/6 from dual);

ALTER SYSTEM SWITCH LOGFILE;
2. No Servidor STANDBY - Verifique se o Archive foi Recebido:

set lines 100
set pages 10
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
select THREAD#,Sequence#,first_time,next_time,applied
from v$archived_log where dest_id=5 and
(COMPLETION_TIME) >= (select sysdate-1/6 from dual);



-- ----------------------------------------------------------------------------------------
-- Para Limpar as configurações do Standby no Banco de Dados Primario
-- ----------------------------------------------------------------------------------------
# No RMAN
rman target sys/orakroiuni@DWMSAF catalog rman/mu2t4ng
CONFIGURE ARCHIVELOG DELETION POLICY TO NONE;

# No Banco (SQL*Plus)
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_6='' scope=both sid='*';
alter system set log_archive_config=NODG_CONFIG  scope=both sid='*';
alter system set FAL_SERVER='' scope=both sid='*';
alter system set FAL_CLIENT='' scope=both sid='*';
ALTER SYSTEM set archive_lag_target=0 scope=both sid='*';



--> Verificar Status das Configurações
set lines 300
set pages 100
col DEST_NAME for a30
col DESTINATION for a30
select DEST_ID, DEST_NAME,DESTINATION from v$archive_dest;
select DEST_NAME,status,error from  v$archive_dest;  

  
-- ------------------------------------------------------------------------------
   PREPARANDO PARA O SWITCHOVER - BDPRODDR (X4) --> BDPRODST (X8)
-- ------------------------------------------------------------------------------

-- Verificando sincronismo entre o X4 e X8

--------------------------------Primary (X4) - BDPRODDR
set lines 300
set pages 100
col DEST_NAME for a30
col error for a90
select INST_ID, DEST_NAME,status,error from  gv$archive_dest
where DEST_NAME = 'LOG_ARCHIVE_DEST_2';


--------------------------------Standby (X8) - BDPRODST
Set pages 50
SELECT
INST_ID,
PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM GV$MANAGED_STANDBY
where PROCESS like '%MRP%';


Set pages 50
SELECT PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM V$MANAGED_STANDBY;
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG
where APPLIED <> 'YES'
and NEXT_TIME > sysdate-1
ORDER BY SEQUENCE#;


set pages 10
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG ORDER BY NEXT_TIME;

set lines 900
SELECT TO_CHAR(A.NEXT_TIME, 'DD/MM/YY HH24:MI:SS') "Last Applied",
A.SEQUENCE# "# Applied",
TO_CHAR(B.NEXT_TIME, 'DD/MM/YY HH24:MI:SS') "Last Received",
B.SEQUENCE# "# Received",
B.SEQUENCE# - A.SEQUENCE# "# Diff",
ROUND(B.NEXT_TIME - A.NEXT_TIME) TIME_IN_DAYS,
ROUND((B.NEXT_TIME - A.NEXT_TIME) * 24) TIME_IN_HOURS,
ROUND((B.NEXT_TIME - A.NEXT_TIME) * 24, 2) * 60 TIME_IN_MINUTES,
ROUND((B.NEXT_TIME - A.NEXT_TIME) * 24, 2) * 3600 TIME_IN_SECONDS
FROM V$ARCHIVED_LOG A, V$ARCHIVED_LOG B
WHERE A.SEQUENCE# =
(SELECT MAX(SEQUENCE#) FROM V$ARCHIVED_LOG WHERE APPLIED = 'YES')
AND B.SEQUENCE# = (SELECT MAX(SEQUENCE#) FROM V$ARCHIVED_LOG);
-- ----------------------------------------------------------------------------------------
-- SWITCHOVER - DATABASE
-- ----------------------------------------------------------------------------------------

--> No banco STANDBY - BDPRODST (X8)

ALTER DATABASE FORCE LOGGING;
#alter system set log_archive_config='dg_config=(BDPRODST,bdproddr)' scope=both sid='*';
alter system set log_archive_config='dg_config=(BDPRODST,bdproddr,bdprods)' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='SERVICE=BDPROD_x4 VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=bdproddr' scope=both sid='*';
alter system set LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_2='service=BDPRODS_x5 VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=bdprods' scope=both sid='*';
alter system set LOG_ARCHIVE_DEST_STATE_2=DEFER scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_MAX_PROCESSES=10 scope=both sid='*';
alter system set standby_file_management=AUTO scope=both sid='*';
ALTER SYSTEM SET FAL_SERVER='bdproddr,bdprods' scope=both sid='*';
alter system set FAL_CLIENT='BDPRODST' scope=both sid='*';


>>> SWITCHOVER <<<

--> NO PRIMARIO - bdproddr (X4)
select db_unique_name,database_role,switchover_status from gv$database;
*obs: O RETORNO DEVE SEMPRE SER "SESSIONS ACTIVE" OR "TO STANDBY"

alter database switchover to BDPRODST verify;



>>> REALIZAR O SWITCHOVER DE PRIMARY PARA STB <<<

--> NO PRIMARIO - bdproddr (X4)
alter database commit to switchover to standby with session shutdown;
startup mount;
select name, database_role, guard_status, open_mode from gv$database;
alter system set LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';
alter system set LOG_ARCHIVE_DEST_STATE_2=DEFER scope=both sid='*';



>>> NO AMBIENTE STB, REALIZAR A CONVERSÃO PARA PRIMARY <<<

--> NO STANDBY - BDPRODST (X8)
alter database recover managed standby database cancel;
select switchover_status from gv$database;
*obs: O RETORNO DEVE SEMPRE SER "NOT ALLOWED" OR "TO PRIMARY"

-->SWITCHOVER DE STB PARA PRIMARY - BDPRODST (X8)
alter database commit to switchover to primary with session shutdown;
select name,database_role,protection_mode from gv$database;



>>> APLICANDO DATAGUARD NO ANTIGO PRIMARIO <<<

- STDBY (antigo PRIMARIO) - bdproddr (X4)
alter database recover managed standby database using current logfile disconnect from session;
--> verifique o status do MRP ...

- PRIMARIO (antigo STANDBY) - BDPRODST (X8)
alter system set LOG_ARCHIVE_DEST_STATE_5=ENABLE scope=both sid='*';
alter system set LOG_ARCHIVE_DEST_STATE_2=ENABLE scope=both sid='*';
alter database open;



>>> ATUALIZAR PARAMETROS DE INICIALIZACAO PARA A "NOVA" PRODUCAO - BDPRODST - X8 <<<

create pfile='/home/oracle/pfilebdproddr.bkp' from spfile;

alter system set cursor_sharing=EXACT scope=spfile sid='*';
alter system set db_cache_size=0 scope=spfile sid='*';
alter system set db_files=2048 scope=spfile sid='*';
alter system set db_writer_processes=6 scope=spfile sid='*';
alter system set job_queue_processes=1000 scope=spfile sid='*';
alter system set open_cursors=8192 scope=spfile sid='*';
alter system set pga_aggregate_limit=27917287424 scope=spfile sid='*';
alter system set pga_aggregate_target=17179869184 scope=spfile sid='*';
alter system set processes=13500 scope=spfile sid='*';
alter system set session_cached_cursors=600 scope=spfile sid='*';
alter system set session_max_open_files=10 scope=spfile sid='*';
alter system set sessions=20304 scope=spfile sid='*';
alter system set sga_max_size=107374182400 scope=spfile sid='*';
alter system set sga_target=85899345920 scope=spfile sid='*';
alter system set shared_pool_reserved_size=2147483648 scope=spfile sid='*';
alter system set shared_pool_size=16106127360 scope=spfile sid='*';

--> STOP / START - srvctl stop database -d bdprodst



>>> RODAR COLETAS DE ESTATISTICAS DE DICIONARIO E EXADATA - BDPRODST - X8 <<<

ALTER SESSION FORCE PARALLEL DDL PARALLEL 8;
ALTER SESSION FORCE PARALLEL DML PARALLEL 8;
ALTER SESSION FORCE PARALLEL QUERY PARALLEL 8;
  
begin DBMS_STATS.gather_dictionary_stats;end;  
/
  
begin DBMS_STATS.gather_system_stats;end;      
/
  
begin DBMS_STATS.GATHER_FIXED_OBJECTS_STATS;end;                                            
/
  
begin dbms_stats.gather_system_stats('EXADATA');end;                                        
/    




>>> VERIFICANDO STATUS DO BANCO BDPRODS NO X5 <<<

- DR - bdprods - X5
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;

alter system set log_archive_config='dg_config=(BDPRODST)' scope=both sid='*';
ALTER SYSTEM SET FAL_SERVER='BDPRODST' scope=both sid='*';
alter system set FAL_CLIENT='BDPRODS' scope=both sid='*';

ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6;

--> verifique o status do MRP ...


-- --------------------- ATIVIDADES APOS O SWITCHOVER

-1- Verificar status do banco replicado no X4 - bdproddr --> Manter o banco em modo MOUNT.
-2- Verificar a rotina de manutenção de archives no X4 - bdproddr (manter 16 horas).
-3- Verificar a replicação e status no X5 - BDPRODs - Manter o banco em modo Open Readonly.
-4- Verificar rotina de manutencao de archives no X5 - BDPRODs.
-5- Verificar entradas de TNS do Nelson no X8.

-6- Cancelar todas as rotinas de backup do RMAN para o banco BDPRODDR no X4.
-7- Criar as rotinas de Backup para o banco BDPRODST no X8 - Oracle Wallet e etc.




---

---
Add Cluster
---

---

-- ----------------------------------------------------------------------------------------
-->AMBIENTE PRIMARIO
db_name:                 peda5o
db_unique_name:            peda5os

-- ----------------------------------------------------------------------------------------

-- RESTORE DATABASE
-2- Criar a entrada do banco bdprodexa no arquivo /etc/oratab
    echo -e "peda5os:/u01/app/oracle/product/12.2.0.1/dbhome_1:N" >> /etc/oratab    

    B) Criar o diretório "admin" para o banco Standby no Exadata X8.
            mkdir -p /u01/app/oracle/admin/peda5os/adump
    
    C) Criar um init (ORACLE_HOME/dbs/initpeda5os.ora) para o banco Standby somente com os parâmetros:

_disk_sector_size_override=TRUE
audit_file_dest='/u01/app/oracle/admin/peda5os/adump'
cluster_database=false
compatible='12.2.0.1.0'
control_files='+DATAC1/peda5os/CONTROLFILE/control01','+RECOC1/peda5os/CONTROLFILE/control02'
db_create_file_dest='+DATAC1'
db_create_online_log_dest_1='+RECOC1'
db_create_online_log_dest_2='+DATAC1'
db_files=1024
db_keep_cache_size=536870912
db_name='peda5o'
db_unique_name='peda5os'
diagnostic_dest='/u01/app/oracle'
log_archive_dest_1='location=+RECOC1 valid_for=(ALL_LOGFILES,ALL_ROLES)'
log_archive_max_processes=10
log_file_name_convert='/u03/oradata/peda5o','+RECOC1/peda5os/ONLINELOG','/u03/oradata/peda5o','+DATAC1/peda5os/ONLINELOG'
open_cursors=2000
processes=5000
resource_limit=FALSE
service_names='peda5o,peda5os'
session_cached_cursors=100
sessions=7000
sga_max_size=6G
sga_target=6G
shared_pool_size=2G
job_queue_processes=0
standby_file_management='AUTO'

--> criar novamente o SPFILE a partir do PFILE alterado
startup nomount
create spfile='+DATAC1/peda5os/spfilepeda5os.ora' from pfile;
!echo "spfile='+DATAC1/peda5os/spfilepeda5os.ora'" > /u01/app/oracle/product/12.2.0.1/dbhome_1/dbs/initpeda5os.ora
--> fazer o shutdown e o startup nomount (utilizando o spfile restaurado e corrigido) - shutdown immediate / startup nomount

-5- restaurar controlfile do backup (verifique no catalogo ou log do backup qual o backuppeace do CONTROLFILE)
restore controlfile from '/u02/SOMOS/peda5O_tmp/control_PEDA5O_fhuufk89_1_1';
    
--> montar o banco de dados com os controlfiles restaurados - no rman mesmo - alter database mount;

-6- Catalogar o restante dos Backup pieaces necessários para o completo restore do banco de dados

run {
crosscheck archivelog all;
delete force noprompt expired archivelog all;
crosscheck backup;
delete force noprompt expired backup;
delete force noprompt obsolete;
}

catalog start with '/u02/SOMOS/peda5O_tmp';    
--CATALOG BACKUPPIECE '/u01/app/oracle/TRANSF/peda5o/FULL_COLDTP172HST_20191005_4233898410_3140_24udi4n5_1_1.bkp';


----[ IMPORTANTE: Criar a estrutura de diretorios ]
cd +DATAC1/peda5os/
mkdir DATAFILE
mkdir ONLINELOG
cd +RECOC1/peda5os
mkdir ONLINELOG



-7- Preparar o banco para o restore ...

IMPORTANTE!
1) Gerar o "alter database rename file" para os REDOLOGs serem criado no local nodo do banco tp172hsts:

set head off pages 0 feed off echo off verify off
set lines 600
set pages 300

select 'SQL "alter database rename file '''''|| member ||''''' '||chr(10)|| ' TO ''''' || '+RECOC1/peda5os/onlinelog/' || substr(member,instr(member,'/',-1)+1) || ''''' ";'
from v$logfile
where member like '%peda5o%';

select 'SQL "alter database rename file '''''|| member ||''''' '||chr(10)|| ' TO ''''' || '+DATAC1/peda5os/onlinelog/' || substr(member,instr(member,'/',-1)+1) || ''''' ";'
from v$logfile
where member like '/u01/oradata/peda5o%';


--> Rodar o script de rename dos REDOS no RMAN:
SQL "alter database rename file ''/u01/oradata/peda5o/redo01a.log''
TO ''+RECOC1/peda5os/onlinelog/redo01a.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo01b.log''
TO ''+RECOC1/peda5os/onlinelog/redo01b.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo02a.log''
TO ''+RECOC1/peda5os/onlinelog/redo02a.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo02b.log''
TO ''+RECOC1/peda5os/onlinelog/redo02b.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo03a.log''
TO ''+RECOC1/peda5os/onlinelog/redo03a.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo03b.log''
TO ''+RECOC1/peda5os/onlinelog/redo03b.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo04a.log''
TO ''+RECOC1/peda5os/onlinelog/redo04a.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo04b.log''
TO ''+RECOC1/peda5os/onlinelog/redo04b.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo05a.log''
TO ''+RECOC1/peda5os/onlinelog/redo05a.log'' ";

SQL "alter database rename file ''/u01/oradata/peda5o/redo05b.log''
TO ''+RECOC1/peda5os/onlinelog/redo05b.log'' ";


-8- Restaurar o banco de dados
--> Bloco RUN para o restore com RMAN:
RUN {
allocate channel ch1 type disk;
allocate channel ch2 type disk;
allocate channel ch3 type disk;
allocate channel ch4 type disk;
allocate channel ch5 type disk;
allocate channel ch6 type disk;
allocate channel ch7 type disk;
allocate channel ch8 type disk;
allocate channel ch9 type disk;
allocate channel ch10 type disk;
allocate channel ch11 type disk;
allocate channel ch12 type disk;
set newname for database to '+DATAC1/peda5os/datafile/%b';
RESTORE DATABASE;
SWITCH DATAFILE ALL;
RECOVER DATABASE;
}

--> restaurando na sessao VNC :7 ...


IMPORTANTE: Se der a mensagem RMAN-06054  --> pode abrir o banco com RESETLOGS


-9- Abrir o banco de dados restaurado com RESETLOGS
SQL> alter database open resetlogs;
Database altered.



-- ------------------------------------------------------------------
   CONFIGURE CLUSTER DATABASE                                            >>> TEMPO: 20Minutos <<<
-- ------------------------------------------------------------------

--> criar SPFILE no ASM
echo "spfile='+DATAC1/peda5os/spfilepeda5os.ora'" > /u01/app/oracle/product/12.2.0.1/dbhome_1/dbs/initpeda5os1.ora
ssh krtn03db02 "echo \"spfile='+DATAC1/peda5os/spfilepeda5os.ora''\" > /u01/app/oracle/product/12.2.0.1/dbhome_1/dbs/initpeda5os2.ora"
ssh krtn03db03 "echo \"spfile='+DATAC1/peda5os/spfilepeda5os.ora''\" > /u01/app/oracle/product/12.2.0.1/dbhome_1/dbs/initpeda5os3.ora"
ssh krtn03db04 "echo \"spfile='+DATAC1/peda5os/spfilepeda5os.ora''\" > /u01/app/oracle/product/12.2.0.1/dbhome_1/dbs/initpeda5os4.ora"

--> copiar o ORAPWFILE
cp /u02/SOMOS/peda5O/orapwpeda5o /u01/app/oracle/product/12.2.0.1/dbhome_1/dbs/orapwpeda5os1

--> criar audi directory
mkdir -p /u01/app/oracle/admin/peda5os1/adump
ssh krtn03db02 "mkdir -p /u01/app/oracle/admin/peda5os2/adump"
ssh krtn03db03 "mkdir -p /u01/app/oracle/admin/peda5os3/adump"
ssh krtn03db04 "mkdir -p /u01/app/oracle/admin/peda5os4/adump"

--> entradas no /etc/oratab
echo "peda5os1:/u01/app/oracle/product/12.2.0.1/dbhome_1:N" >> /etc/oratab
ssh krtn03db02 "echo 'peda5os2:/u01/app/oracle/product/12.2.0.1/dbhome_1:N' >> /etc/oratab"
ssh krtn03db03 "echo 'peda5os3:/u01/app/oracle/product/12.2.0.1/dbhome_1:N' >> /etc/oratab"
ssh krtn03db04 "echo 'peda5os4:/u01/app/oracle/product/12.2.0.1/dbhome_1:N' >> /etc/oratab"


--> Alterar no SPFILE os parametros:
alter system set  audit_file_dest='/u01/app/oracle/admin/peda5os1/adump' scope=spfile sid='peda5os1';
alter system set  audit_file_dest='/u01/app/oracle/admin/peda5os2/adump' scope=spfile sid='peda5os2';
alter system set  audit_file_dest='/u01/app/oracle/admin/peda5os3/adump' scope=spfile sid='peda5os3';
alter system set  audit_file_dest='/u01/app/oracle/admin/peda5os4/adump' scope=spfile sid='peda5os4';

alter system set instance_number=1 scope=spfile sid='peda5os1';
alter system set instance_number=2 scope=spfile sid='peda5os2';
alter system set instance_number=3 scope=spfile sid='peda5os3';
alter system set instance_number=4 scope=spfile sid='peda5os4';

ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 1000 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 1001 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 1002 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 1003 ('+RECOC1','+DATAC1') SIZE 128m;

ALTER DATABASE ADD LOGFILE THREAD 2 GROUP 2000 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 2 GROUP 2001 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 2 GROUP 2002 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 2 GROUP 2003 ('+RECOC1','+DATAC1') SIZE 128m;

ALTER DATABASE ADD LOGFILE THREAD 3 GROUP 3000 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 3 GROUP 3001 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 3 GROUP 3002 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 3 GROUP 3003 ('+RECOC1','+DATAC1') SIZE 128m;

ALTER DATABASE ADD LOGFILE THREAD 4 GROUP 4000 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 4 GROUP 4001 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 4 GROUP 4002 ('+RECOC1','+DATAC1') SIZE 128m;
ALTER DATABASE ADD LOGFILE THREAD 4 GROUP 4003 ('+RECOC1','+DATAC1') SIZE 128m;

alter system set thread=1 scope=spfile sid='peda5os1';
alter system set thread=2 scope=spfile sid='peda5os2';
alter system set thread=3 scope=spfile sid='peda5os3';
alter system set thread=4 scope=spfile sid='peda5os4';

alter database enable thread 1;
alter database enable thread 2;
alter database enable thread 3;
alter database enable thread 4;

alter system set undo_tablespace='UNDOTBS01' scope=spfile sid='peda5os1';
alter system set undo_tablespace='UNDOTBS02' scope=spfile sid='peda5os2';
alter system set undo_tablespace='UNDOTBS03' scope=spfile sid='peda5os3';
alter system set undo_tablespace='UNDOTBS04' scope=spfile sid='peda5os4';


create undo tablespace UNDOTBS01 DATAFILE '+DATAC1' SIZE 12G;
create undo tablespace UNDOTBS02 DATAFILE '+DATAC1' SIZE 12G;
create undo tablespace UNDOTBS03 DATAFILE '+DATAC1' SIZE 12G;
create undo tablespace UNDOTBS04 DATAFILE '+DATAC1' SIZE 12G;

alter system set undo_tablespace='UNDOTBS01' scope=spfile sid='peda5os1';
alter system set undo_tablespace='UNDOTBS02' scope=spfile sid='peda5os2';
alter system set undo_tablespace='UNDOTBS03' scope=spfile sid='peda5os3';
alter system set undo_tablespace='UNDOTBS04' scope=spfile sid='peda5os4';

alter system set local_listener='(ADDRESS=(PROTOCOL=TCP)(HOST=172.16.142.245)(PORT=1521))' scope=both sid='peda5os1';
alter system set local_listener='(ADDRESS=(PROTOCOL=TCP)(HOST=172.16.142.246)(PORT=1521))' scope=both sid='peda5os2';
alter system set local_listener='(ADDRESS=(PROTOCOL=TCP)(HOST=172.16.142.247)(PORT=1521))' scope=both sid='peda5os3';
alter system set local_listener='(ADDRESS=(PROTOCOL=TCP)(HOST=172.16.142.248)(PORT=1521))' scope=both sid='peda5os4';

alter system set remote_listener='' scope=both sid='*';
alter system set remote_listener='krtn3-scan:1521','krtn3-scan.pitagoras.apollo.br:1521' scope=both sid='*';
alter system register;

alter system set cluster_database=true scope=spfile sid='*';


--> Adicionar o banco no Clusterware (Em qualquer DBNODE com usuario "oracle")

srvctl add database -d peda5os -o /u01/app/oracle/product/12.2.0.1/dbhome_1 -p +DATAC1/peda5os/spfilepeda5os.ora -y automatic -a "DATAC1,RECOC1"

srvctl add instance -d peda5os -i peda5os1 -n krtn03db01
srvctl add instance -d peda5os -i peda5os2 -n krtn03db02
srvctl add instance -d peda5os -i peda5os3 -n krtn03db03
srvctl add instance -d peda5os -i peda5os4 -n krtn03db04

--> Criar copia de segurança do SPFILE após aletrações
create pfile='/home/oracle/pfileCluster_peda5os.ora' from spfile;

--> SHUTDOWN NO SINGLE INSTANCE / STARTUP VIA CLUSTER - shutdown immediate / srvctl start database -d peda5os


--> REMOVER GRUPOS ANTIGOS DE REDOLOG

--Verificar os Novos Grupos de REDOLOG
set lines 300
set pages 100
col REDOLOG_FILE_NAME for a60
SELECT a.GROUP#, a.THREAD#, a.SEQUENCE#,
a.ARCHIVED, a.STATUS, b.MEMBER AS REDOLOG_FILE_NAME,
(a.BYTES/1024/1024) AS SIZE_MB FROM v$log a
JOIN v$logfile b ON a.Group#=b.Group#
ORDER BY a.GROUP#;

--Gerar linha de comando e executar no ASMCMD [GRID] -> Depois de removidos os grupos >>>> NUNCA ANTES!!!! <<<<<
set lines 100
select 'rm '||MEMBER from v$logfile
where GROUP# < 1000;

--Gerar linha de comando e executar no SQLPLUS - [DROP LOG GROUP]:
set lines 100
select 'Alter database drop logfile group '||GROUP#||';' from v$log
where STATUS in ('INACTIVE','UNUSED')
and GROUP# < 1000;

--Fazer "rodar" a utilização dos grupos:
alter system switch logfile;

--Definir onde a Instancia vai rodar
srvctl disable instance -d peda5os -i "peda5os1,peda5os3,peda5os4"


--Copiar orapw para o ASM
ASMCMD> pwcopy /u02/SOMOS/peda5O/orapwpeda5o +DATAC1/peda5os/orapwpeda5os

oracle> srvctl modify database -d peda5os -pwfile +DATAC1/peda5os/orapwpeda5os


--Ajustando a tablespace TEMP
select 'alter database tempfile '''||NAME||''' drop including datafiles;' from v$tempfile;

alter tablespace TEMP add tempfile '+DATAC1/peda5os/datafile/TEMP_01' size 20G;
alter tablespace TEMP_ZB add tempfile '+DATAC1/peda5os/datafile/TEMP_ZB_01' size 20G;
alter tablespace OTMPRD_IAS_TEMP add tempfile '+DATAC1/peda5os/datafile/OTMPRD_IAS_TEMP_01' size 20G;
alter tablespace OSBPRD12C_IAS_TEMP add tempfile '+DATAC1/peda5os/datafile/OSBPRD12C_IAS_TEMP_01' size 20G;
alter tablespace SOAPRD12C_IAS_TEMP add tempfile '+DATAC1/peda5os/datafile/SOAPRD12C_IAS_TEMP_01' size 20G;


--Consultar e validar as TEMPS
set lines 300
col name for a20
SELECT d.status "Status", d.tablespace_name "Name", d.contents "Type", d.extent_management
"ExtManag",
TO_CHAR(NVL(a.bytes / 1024 / 1024, 0),'99,999,990.900') "Size (M)", TO_CHAR(NVL(t.bytes,
0)/1024/1024,'99999,999.999') ||'/'||TO_CHAR(NVL(a.bytes/1024/1024, 0),'99999,999.999') "Used (M)",
TO_CHAR(NVL(t.bytes / a.bytes * 100, 0), '990.00') "Used %"
FROM sys.dba_tablespaces d, (select tablespace_name, sum(bytes) bytes from dba_temp_files group by
tablespace_name) a,
(select tablespace_name, sum(bytes_cached) bytes from
v$temp_extent_pool group by tablespace_name) t
WHERE d.tablespace_name = a.tablespace_name(+) AND d.tablespace_name = t.tablespace_name(+)
AND d.extent_management like 'LOCAL' AND d.contents like 'TEMPORARY';



--> criar usuário para o backuip RMAN

CREATE USER "BKP_TSM" IDENTIFIED BY Mu2t4ng
    DEFAULT TABLESPACE "USERS"
    TEMPORARY TABLESPACE "TEMP";

GRANT SELECT ANY DICTIONARY TO "BKP_TSM";
GRANT EXEMPT ACCESS POLICY TO "BKP_TSM";
GRANT UNLIMITED TABLESPACE TO "BKP_TSM";
GRANT CREATE SESSION TO "BKP_TSM";

GRANT CONNECT TO "BKP_TSM";
GRANT "DBA" TO "BKP_TSM";
GRANT SYSDBA TO "BKP_TSM";
GRANT SYSBACKUP TO "BKP_TSM";




-- ----------------------------------------------------------
-- Removendo do CLUSTER
-- ----------------------------------------------------------

--Alterando o parametro CLUSTER do banco para false
alter system set cluster_database=false scope=spfile sid='*';

-- removendo o banco do cluster
srvctl stop database -d peda5os -f

srvctl remove instance -d peda5os -i peda5os1
srvctl remove instance -d peda5os -i peda5os2
srvctl remove instance -d peda5os -i peda5os3
srvctl remove instance -d peda5os -i peda5os4

srvctl remove database -d peda5os

--criando o arquivo pfile SINGLE apontando para o SPFILE no ASM (no NODE4)
echo "spfile='+DATAC1/peda5os/spfilepeda5os.ora'" > /u01/app/oracle/product/12.2.0.1/dbhome_1/dbs/initpeda5os.ora

--criando entrada single instance no /etc/oratab
echo "peda5os:/u01/app/oracle/product/12.2.0.1/dbhome_1:N" >> /etc/oratab

--criando audit file
mkdir -p /u01/app/oracle/admin/peda5os/adump

--Subir o banco em Single INSTANCE
. oraenv
peda5os

sqlplus / as sysdba
startup




-- ----------------------------------------------------------------------------------------
-->AMBIENTE PRIMARIO

Servidores Primarios:      krtn1db01.pitagoras.apollo.br
                              krtn1db02.pitagoras.apollo.br
                              krtn1db03.pitagoras.apollo.br
                              krtn1db04.pitagoras.apollo.br
                             
TNS_Primarios:                bdprod / bdprod_link


-->AMBIENTE STANDBY
db_name:                     bdprod
db_unique_name:               bdproddr
Servidor standby:           krtn03db01
TNS_Standby:                bdprod_x8
-- ----------------------------------------------------------------------------------------

--> PRIMARY [X4] - Criar um serviÃ§o para conectar sempre na mesma Instancia no ambiente PRIMARIO

IMPORTANTE: adicionar o serviÃ§o bdprod_link no parametro service_names no banco de dados (em todas as instÃ¢ncias).

alter system set service_names='bdproddr, bdprodexa, bdprod_link' scope=both sid='*';

(#oracle) srvctl add service -d bdproddr -s bdprod_link -r bdproddr1
(#oracle) srvctl start service -d bdproddr -s bdprod_link


--> CONFIGURACOES DE TNS

#STANDBY - Subir um Listener LOCAL no "Servidor Standby" #-- Verificar se temos portas liberadas.
#Utilizando o LISTENER da InstalaÃ§Ã£o do GRID.                #-- Verificar se temos portas liberadas.

PRIMARY [X4] - Adicionar entradas no tnsnames.ora

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
BDPROD_x8 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.142.241)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodst)
  (UR=A)
  )
)

bdprod_link =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprod_link)
  )
)

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]


STANDBY [X8 - 12.1] - Adicionar entradas no tnsnames.ora

#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
BDPROD_x8 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = 172.16.142.241)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodst)
  (UR=A)
  )
)

BDPROD_x4 =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprodexa)
  )
)
bdprod_link =
(DESCRIPTION =
  (ADDRESS = (PROTOCOL = TCP)(HOST = krtn4-scan.pitagoras.apollo.br)(PORT = 1521))
   (CONNECT_DATA =
   (SERVER = DEDICATED)
   (SERVICE_NAME = bdprod_link)
  )
)
#---------------------------------------------------------------[ DUPLICATE PARA X8 ]
--> PRIMARY [X4] - Configuracoes do Oracle Dataguard

ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';

alter system set LOG_ARCHIVE_CONFIG='DG_CONFIG=(bdproddr,bdprods,bdprodst)' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='SERVICE=BDPROD_x8 VALID_FOR=(ONLINE_LOGFILES,PRIMARY_ROLE) DB_UNIQUE_NAME=BDPRODST' scope=both sid='*';
alter system set FAL_SERVER='BDPRODS','BDPRODST' scope=both sid='*';

STANDBY [X8 - 12.1] - Preparar o Banco Standby (auxiliary)
UvPaMgAacQ#B
     A) Copiar o arquivo PasswordFile do Banco PROMARIO [X4] para o Banco Standby (renomear o arquivo conforme nome do banco Standby)
scp orapwbdprodst1 oracle@krtn03db01:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst
scp orapwbdprodst1 oracle@krtn03db02:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst2
scp orapwbdprodst1 oracle@krtn03db03:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst3
scp orapwbdprodst1 oracle@krtn03db04:/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwbdprodst4
       
        - Se for necessario recirar o passwordfile:
               -1- Verifique os detalhes do arquivo atual (banco PRIMARIO [X3]):
                    select 'grant sysdba to '||USERNAME||';' from v$pwfile_users;
              
               -2- Altere a senha do usuari SYS no banco PRIMARIO [X3]
              
               -3- Recrie o arquivo passwordfile no X3 (NecessÃ¡rio em todos os DBNODEs):
                    orapwd file='/u01/app/oracle/product/12.1.0.2/dbhome_1/dbs/orapwDWMSAF' entries=40
    
     B) Criar o diretÃ³rio "admin" para o banco Standby no Exadata X8.
          mkdir -p /u01/app/oracle/admin/BDPRODST/adump
    
     C) Criar um init (ORACLE_HOME/dbs/initBDPRODST.ora) para o banco Standby somente com os parÃ¢metros:
    
*.audit_file_dest='/u01/app/oracle/admin/BDPRODST/adump'
*.cluster_database=false
*.compatible='12.1.0.2.0'
*.control_files='+DATAC1/BDPRODST/CONTROLFILE/control01','+RECOC1/BDPRODST/CONTROLFILE/control02'
*.db_create_file_dest='+DATAC1'
*.db_create_online_log_dest_1='+RECOC1'
*.db_create_online_log_dest_2='+DATAC1'
*.db_files=1024
*.db_keep_cache_size=536870912
*.diagnostic_dest='/u01/app/oracle'
*.resource_limit=FALSE
*.db_name='BDPROD'
*.db_unique_name='BDPRODST'
*.log_archive_max_processes=10
*.fal_client='BDPRODST'
*.fal_server='BDPRODDR'
*.log_archive_config='dg_config=(bdproddr,bdprods,bdprodst)'
*.log_archive_dest_1='location=+RECOC1 valid_for=(ALL_LOGFILES,ALL_ROLES)'
*.log_archive_dest_5='service="BDPROD_x4" valid_for=(ONLINE_LOGFILES,PRIMARY_ROLE)'
*.log_archive_dest_state_5='DEFER'
*.log_file_name_convert='+RECOC1/BDPRODDR/ONLINELOG','+RECOC1/BDPRODST/ONLINELOG','+DATAC1/BDPRODDR/ONLINELOG','+DATAC1/BDPRODST/ONLINELOG'
*.open_cursors=2000
*.service_names='bdproddr,bdprodexa'
*._disk_sector_size_override='TRUE'
*.processes=5000
*.session_cached_cursors=100
*.sessions=7000
*.sga_target=6G
*.sga_max_size=6G
*.shared_pool_size=2G
*.standby_file_management='AUTO'

     D) Startup NOMOUNT do banco STANDBY no X8 (auxiliary).


    
STANDBY [X8 - 12.1] - Iniciando o DUPLICATE ONLINE do X3 para o X8

     Em um dos servidores do X8 (Estou trabalhando no NODE1)
          A) export ORACLE_SID=BDPRODST
          B) rman target sys/Exasyskrot01@bdprod_link auxiliary sys/Exasyskrot01@BDPROD_x8         
         
          C) Duplicar o Banco PrimÃ¡rio como Standby (On-Line):


run {
allocate channel bdprodP1 type disk;
allocate channel bdprodP2 type disk;
allocate channel bdprodP3 type disk;
allocate channel bdprodP4 type disk;
allocate channel bdprodP5 type disk;
allocate channel bdprodP6 type disk;
allocate channel bdprodP7 type disk;
allocate channel bdprodP8 type disk;
allocate channel bdprodP10 type disk;
allocate channel bdprodP11 type disk;
allocate channel bdprodP12 type disk;
allocate channel bdprodP13 type disk;
allocate channel bdprodP14 type disk;
allocate channel bdprodP15 type disk;
allocate channel bdprodP16 type disk;
allocate channel bdprodP17 type disk;
allocate channel bdprodP18 type disk;
allocate channel bdprodP19 type disk;
allocate channel bdprodP20 type disk;
allocate channel bdprodP21 type disk;
allocate channel bdprodP22 type disk;
allocate auxiliary channel      bdprodSTB1     type disk;
allocate auxiliary channel      bdprodSTB2     type disk;
allocate auxiliary channel      bdprodSTB3     type disk;
allocate auxiliary channel      bdprodSTB4     type disk;
allocate auxiliary channel      bdprodSTB5     type disk;
allocate auxiliary channel      bdprodSTB6     type disk;
allocate auxiliary channel      bdprodSTB7      type disk;
allocate auxiliary channel      bdprodSTB8   type disk;
allocate auxiliary channel      bdprodSTB10  type disk;
allocate auxiliary channel      bdprodSTB11  type disk;
allocate auxiliary channel      bdprodSTB12  type disk;
allocate auxiliary channel      bdprodSTB13  type disk;
allocate auxiliary channel      bdprodSTB14  type disk;
allocate auxiliary channel      bdprodSTB15  type disk;
allocate auxiliary channel      bdprodSTB16  type disk;
allocate auxiliary channel      bdprodSTB17  type disk;
allocate auxiliary channel      bdprodSTB18  type disk;
allocate auxiliary channel      bdprodSTB19  type disk;
allocate auxiliary channel      bdprodSTB20  type disk;
allocate auxiliary channel      bdprodSTB21  type disk;
allocate auxiliary channel      bdprodSTB22  type disk;
duplicate target database for standby from active database;
}


nohup rman target sys/@bdprod_link auxiliary sys/@BDPROD_x8 @/home/oracle/duplicate_x4/rman_bdproddr.cmd > nohup_$ORACLE_SID.out 2>&1&

-- -------------------------------------------------------------------------------------
-- MONITORAR O ANDAMENTO DO DUPLICATE  [No Banco PrimÃ¡rio]
-- -------------------------------------------------------------------------------------

# Andamento do Duplicate...
alter session set nls_date_format='dd/mm/yy hh24:mi:ss';
set lines 300
select SID, START_TIME,TOTALWORK, sofar, round(((sofar/totalwork) * 100),2) "% Completed", sysdate + TIME_REMAINING/3600/24 end_at from v$session_longops where totalwork > sofar AND opname NOT LIKE '%aggregate%' AND opname like 'RMAN%'
/

# Eventos de WAIT relacionados ao Duplicate...
REM RMAN waits
set lines 120
column sid format 9999
column spid format 99999
column client_info format a25
column event format a30
column secs format 9999
SELECT SID,SPID, CLIENT_INFO, event, seconds_in_wait secs, p1, p2, p3 FROM V$PROCESS p, V$SESSION s  WHERE p.ADDR = s.PADDR and CLIENT_INFO like 'rman channel=%';



-- ----------------------------------------------------------------------------
     INICIANDO O SERVIÃ‡O â€œMRPâ€ NO SERVIDOR DO STANDBY DATABASE
-- ----------------------------------------------------------------------------
--> No Banco PRIMARY [X4]:
alter system set archive_lag_target=900 scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=ENABLE scope=both sid='*';


--> No Banco STANDBY [X8 - 12.1]:
(No Real Time Apply)
(START).: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT;
            ALTER DATABASE RECOVER MANAGED STANDBY DATABASE DISCONNECT PARALLEL 6;
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;
 
 
(Real Time Apply) 
To  use  Real Time  Apply , Standby  redo  logfiles  are  mandatory.
Once , the standby redo logfiles has been created on the standby use

(START).: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6; 
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL; 
 

(Real Time Query)   
--> O banco deve estar "MONTED" e o serviÃ§o MRP nÃ£o pode estar ativo.
(START).: ALTER DATABASE OPEN;
            ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT;
            ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE DISCONNECT PARALLEL 6;
(STOP)..: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL;

-- ----------------------------------------------------------------------------
     ALTERANDO O STABDBY para READ ONLY
-- ----------------------------------------------------------------------------
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
ALTER DATABASE OPEN READ ONLY;


-- --------------------------------------------------------------------------------
     DISPONIBILIZANDO o BANCO DRP (Failover) -- Interrompendo a ReplicaÃ§Ã£o...
-- --------------------------------------------------------------------------------
--> No Banco PrimÃ¡rio:
ALTER SYSTEM SWITCH LOGFILE;
ALTER SYSTEM SET LOG_ARCHIVE_DEST_STATE_5=DEFER scope=both sid='*';


--> No Banco Standby:
ALTER DATABASE RECOVER MANAGED STANDBY DATABASE FINISH;
ALTER DATABASE ACTIVATE STANDBY DATABASE;

alter database open;

-- ----------------------------------------- EUQUALIZANDO PARAMETROS DO BANCO

--> Pegar os parametros do banco de producao no X4

set lines 200
set pages 100
select 'alter system set '||NAME||'='||VALUE||' scope=spfile sid=''*'';' from  v$parameter
where NAME in ('sga_max_size'
,'sga_target'
,'pga_aggregate_limit'
,'pga_aggregate_target'
,'shared_pool_reserved_size'
,'shared_pool_size'
,'db_cache_size'
,'cursor_sharing'
,'open_cursors'
,'session_cached_cursors'
,'session_max_open_files'
,'sessions'
,'db_writer_processes'
,'job_queue_processes'
,'processes'
,'db_files')
order by NAME;

--> Rodar o resultado no banco de destino no X8

create pfile='/home/oracle/pfile_BDPRODST.bkp' from spfile;


-- -------------------------- MONITORAR O BANCO STANDBY

#VERIFICA STATUS DOS SERVIÃ‡OS DO STANDBY (DATAGUARD).:
Set pages 50
SELECT PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM V$MANAGED_STANDBY;

--> CLUSTER
Set pages 50
SELECT
INST_ID,
PROCESS,
STATUS,
THREAD#,
SEQUENCE#,
BLOCK#,
BLOCKS
FROM GV$MANAGED_STANDBY
where PROCESS like '%MRP%';


#VERIFICA OS ARCHIVES RECEBIDOS E SE FORAM APLICADOS.:
set pages 10
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG ORDER BY SEQUENCE#;


SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG where APPLIED='NO' ORDER BY SEQUENCE#;


--> na ultima 1 hora
SELECT THREAD#, SEQUENCE#,
to_char(FIRST_TIME, 'DD-MM-YYYY HH24:MI:SS') "FIRST_TIME",
to_char(NEXT_TIME, 'DD-MM-YYYY HH24:MI:SS') "NEXT_TIME",
APPLIED
FROM V$ARCHIVED_LOG
where APPLIED <> 'YES'
and NEXT_TIME > sysdate-1
ORDER BY SEQUENCE#;


Set Linesize 400
Col Values For A65
Col Recover_start For A21
Select To_char(START_TIME,'Dd.Mm.Yyyy Hh24:Mi:ss') "Recover_start",To_char(Item)||' = '||To_char(Sofar)||' '||To_char(Units)||' '|| To_char(TIMESTAMP,'Dd.Mm.Yyyy Hh24:Mi') "Values" From V$Recovery_progress Where Start_time=(Select Max(Start_time) From V$Recovery_progress);


SELECT count(*) FROM V$ARCHIVED_LOG where APPLIED='NO' ORDER BY SEQUENCE#;


#VERIFICA OS ERROS NO STANDBY.:
SET LINES 100
SET PAGES 500
SELECT MESSAGE FROM V$DATAGUARD_STATUS; 
 
  
-- ---------------VERIFICAR / MONITORAR os SERVIÃ‡OS no BANCO PRIMARIO
set lines 300
set pages 100
col DEST_NAME for a30
col error for a90
select INST_ID, DEST_NAME,status,error from  gv$archive_dest
where DEST_NAME = 'LOG_ARCHIVE_DEST_5'; 
 
SET LINES 100
SET PAGES 500
SELECT MESSAGE FROM V$DATAGUARD_STATUS;  


-- --------------------------------------------------------------------------------
     VERIFICANDO O SINCRONISMO
-- --------------------------------------------------------------------------------

1. No Servidor PRIMIARIO:

set lines 100
set pages 10
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
select THREAD#, Sequence#,first_time,next_time
from v$archived_log
where (COMPLETION_TIME) >= (select sysdate-1/6 from dual);

ALTER SYSTEM SWITCH LOGFILE;
2. No Servidor STANDBY - Verifique se o Archive foi Recebido:

set lines 100
set pages 10
ALTER SESSION SET nls_date_format='DD-MON-YYYY HH24:MI:SS';
select THREAD#,Sequence#,first_time,next_time,applied
from v$archived_log where dest_id=5 and
(COMPLETION_TIME) >= (select sysdate-1/6 from dual);



-- ----------------------------------------------------------------------------------------
-- Para Limpar as configuraÃ§Ãµes do Standby no Banco de Dados Primario
-- ----------------------------------------------------------------------------------------
# No RMAN
rman target sys/orakroiuni@DWMSAF catalog rman/mu2t4ng
CONFIGURE ARCHIVELOG DELETION POLICY TO NONE;

# No Banco (SQL*Plus)
ALTER SYSTEM SET LOG_ARCHIVE_DEST_5='' scope=both sid='*';
ALTER SYSTEM SET LOG_ARCHIVE_DEST_6='' scope=both sid='*';
alter system set log_archive_config=NODG_CONFIG  scope=both sid='*';
alter system set FAL_SERVER='' scope=both sid='*';
alter system set FAL_CLIENT='' scope=both sid='*';
ALTER SYSTEM set archive_lag_target=0 scope=both sid='*';



--> Verificar Status das ConfiguraÃ§Ãµes
set lines 300
set pages 100
col DEST_NAME for a30
col DESTINATION for a30
select DEST_ID, DEST_NAME,DESTINATION from v$archive_dest;
select DEST_NAME,status,error from  v$archive_dest; 































